JIRA.ViewIssueTabs=(function(){var useHistoryApi=AJS.Meta.get("viewissue-use-history-api")!==false;var AJAX_LOAD_CLASS="ajax-activity-content";var AJAX_LINK_SELECTOR=AJS.format("a.{0}",AJAX_LOAD_CLASS);var issueTabLoadedListeners=[];var $tabWrapper,$tabContents;var xhrInProgress;function dispatchIssueTabLoadedEvent(container){container=container||document;AJS.$.each(issueTabLoadedListeners,function(i,fn){fn(container)})}function bindToTabDivs(container){var $newTabWrapper=AJS.$(container).find(".issuePanelWrapper");var $newTabContents=AJS.$(container).find("#issue_actions_container");$tabContents=$newTabContents.length?$newTabContents:$tabContents;$tabWrapper=$newTabWrapper.length?$newTabWrapper:$tabWrapper}function dispatchIssueTabErrorEvent(smartAjaxResult,activeTabKey){var errorPopup=new JIRA.FormDialog({id:"issue-tab-error-dialog",widthClass:"small",content:JIRA.SmartAjax.buildDialogErrorContent(smartAjaxResult,false)});setActiveTab(activeTabKey);$tabContents.show();errorPopup.show()}function setActiveTab(activeTabKey){AJS.$("#issue-tabs li").each(function(){var $li=AJS.$(this);var tabKey=$li.data("key");var labelHtml=AJS.format("<strong>{0}</strong>",$li.data("label"));if(tabKey==activeTabKey){$li.addClass("active");$li.html(labelHtml)}else{$li.removeClass("active");var id=$li.data("id");var href=$li.data("href");$li.html(AJS.format('<a id="{0}" href="{1}" class="{2}">{3}</a>',id,href,AJAX_LOAD_CLASS,labelHtml))}});enableAjaxOnLinks(AJS.$("#issue-tabs"))}function putTabInLoadingState(activeTabKey){setActiveTab(activeTabKey)}function enableAjaxOnLinks(context){var activeTabKey=AJS.$(context).find("li.active").data("key");AJS.$(context).find(AJAX_LINK_SELECTOR).click(function(event){if(event.metaKey){return }event.preventDefault();if(xhrInProgress){xhrInProgress.abort()}var $a=AJS.$(this);var containerID="#activitymodule div.mod-content";var loadingTabKey=$a.parent().data("key");if(loadingTabKey){putTabInLoadingState(loadingTabKey)}var xhr=JIRA.SmartAjax.makeRequest({jqueryAjaxFn:useHistoryApi?AJS.$.pjax:AJS.$.ajax,headers:{"X-PJAX":true},container:containerID,url:$a.attr("href"),timeout:null,complete:function(xhr,status,smartAjaxResult){if(status!="abort"){xhrInProgress=null;if(!smartAjaxResult.successful){if(smartAjaxResult.status<300||smartAjaxResult.status>=400){dispatchIssueTabErrorEvent(smartAjaxResult,activeTabKey)}return }var container=AJS.$(containerID);var newElements=AJS.$(smartAjaxResult.data);if(!useHistoryApi){smartUpdate(container,newElements)}dispatchIssueTabLoadedEvent(container);JIRA.trace("jira.issue.tab.loaded")}}});jQuery(xhr).throbber({target:$tabWrapper});xhrInProgress=xhr})}function smartUpdate(container,newElements){var newTabs=newElements.filter(".tabwrap");var oldTabs=container.find(".tabwrap");var newContents=newElements.find("#issue_actions_container").contents();var oldContents=$tabContents.contents();if(newTabs.length&&oldTabs.length&&newContents.length&&oldContents.length){oldTabs.replaceWith(newTabs);var currentContentHeight=$tabContents.height();$tabContents.append(newContents);var newContentHeight=$tabContents.height()-currentContentHeight;var visibleHeightDifference=AJS.$(window).scrollTop()+AJS.$(window).height()-($tabContents.offset().top+newContentHeight);if(visibleHeightDifference>0){$tabContents.css("height",newContentHeight+visibleHeightDifference);oldContents.remove();var preDelay=150;setTimeout(function(){var pixelsPerSecond=500;var animSpeed=visibleHeightDifference/pixelsPerSecond*1000;$tabContents.animate({height:newContentHeight},animSpeed,"easeOutQuart",function(){$tabContents.css("height","auto")})},preDelay)}else{$tabContents.empty().append(newContents)}newElements.filter("script").each(function(){AJS.$.globalEval(this.text||this.textContent||this.innerHTML||"")})}else{container.empty().append(newElements)}}function appendHashCodeToLinks(context){AJS.$(context).find(AJAX_LINK_SELECTOR).each(function(){var $a=AJS.$(this);$a.attr("href",$a.attr("href")+"#issue-tabs")})}function processActivityModuleLinks(context){if(!useHistoryApi||AJS.$.support.pjax){enableAjaxOnLinks(context)}else{appendHashCodeToLinks(context)}}function setupMouseoverBehaviour(context){jQuery(context).bind("moveToFinished",function(event,target){jQuery("a.twixi:visible",target).focus()})}function initLivestamp(context){context.find("time.livestamp").livestamp()}function onTabReady(listener){if(jQuery.inArray(listener,issueTabLoadedListeners)<0){issueTabLoadedListeners.push(listener)}}onTabReady(bindToTabDivs);onTabReady(processActivityModuleLinks);onTabReady(setupMouseoverBehaviour);onTabReady(JIRA.userhover);onTabReady(initLivestamp);return{onTabReady:onTabReady,domReady:dispatchIssueTabLoadedEvent}})();AJS.$(function(){if(JIRA.Events.PANEL_REFRESHED){JIRA.bind(JIRA.Events.PANEL_REFRESHED,function(e,panel,$new,$existing){if(panel==="activitymodule"){var $focusedTab=$existing.find("#issue_actions_container > .issue-data-block.focused");if($focusedTab.length===1){$new.find("#"+$focusedTab.attr("id")).addClass("focused")}}})}});JIRA.bind(JIRA.Events.NEW_CONTENT_ADDED,function(event,$el){JIRA.ViewIssueTabs.domReady($el)});